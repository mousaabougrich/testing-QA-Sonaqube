


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > MiningServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.wallet.biochain.services.impl</a>
</div>

<h1>Coverage Summary for Class: MiningServiceImpl (com.wallet.biochain.services.impl)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MiningServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (11/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    85,7%
  </span>
  <span class="absValue">
    (12/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    92,7%
  </span>
  <span class="absValue">
    (51/55)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.wallet.biochain.services.impl;
&nbsp;
&nbsp;import com.wallet.biochain.dto.MiningResultDTO;
&nbsp;import com.wallet.biochain.entities.Block;
&nbsp;import com.wallet.biochain.entities.Transaction;
&nbsp;import com.wallet.biochain.mappers.MiningMapper;
&nbsp;import com.wallet.biochain.services.BlockService;
&nbsp;import com.wallet.biochain.services.CryptographyService;
&nbsp;import com.wallet.biochain.services.MiningService;
&nbsp;import lombok.RequiredArgsConstructor;
&nbsp;import lombok.extern.slf4j.Slf4j;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import java.math.BigDecimal;
&nbsp;import java.util.List;
&nbsp;
<b class="fc">&nbsp;@Slf4j</b>
&nbsp;@Service
&nbsp;@RequiredArgsConstructor
&nbsp;public class MiningServiceImpl implements MiningService {
&nbsp;
&nbsp;    private final BlockService blockService;
&nbsp;    private final CryptographyService cryptographyService;
&nbsp;    private final MiningMapper miningMapper;
&nbsp;
&nbsp;    private static final int DEFAULT_DIFFICULTY = 4;
<b class="fc">&nbsp;    private static final BigDecimal INITIAL_REWARD = new BigDecimal(&quot;50&quot;);</b>
&nbsp;    private static final int HALVING_INTERVAL = 210000;
&nbsp;
&nbsp;    @Override
&nbsp;    public MiningResultDTO mineBlock(List&lt;Transaction&gt; transactions, String minerAddress) {
<b class="fc">&nbsp;        return mineBlockWithDifficulty(transactions, minerAddress, DEFAULT_DIFFICULTY);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public MiningResultDTO mineBlockWithDifficulty(List&lt;Transaction&gt; transactions, String minerAddress, Integer difficulty) {
<b class="fc">&nbsp;        log.info(&quot;Starting mining with difficulty: {}&quot;, difficulty);</b>
<b class="fc">&nbsp;        long startTime = System.currentTimeMillis();</b>
&nbsp;
&nbsp;        try {
&nbsp;            // Get latest block index
<b class="fc">&nbsp;            Integer nextIndex = blockService.getBlockCount().intValue();</b>
<b class="fc">&nbsp;            String previousHash = &quot;0&quot;;</b>
&nbsp;
<b class="pc">&nbsp;            if (nextIndex &gt; 0) {</b>
<b class="fc">&nbsp;                var latestBlock = blockService.getLatestBlock();</b>
<b class="fc">&nbsp;                if (latestBlock.isPresent()) {</b>
<b class="fc">&nbsp;                    previousHash = latestBlock.get().hash();</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            // Create block
<b class="fc">&nbsp;            Block block = blockService.createBlock(nextIndex, previousHash, transactions);</b>
&nbsp;            // Ensure previous hash is set on the block (some implementations/tests assert this explicitly)
<b class="fc">&nbsp;            block.setPreviousHash(previousHash);</b>
<b class="fc">&nbsp;            block.setDifficulty(difficulty);</b>
<b class="fc">&nbsp;            block.setMinerAddress(minerAddress);</b>
&nbsp;
&nbsp;            // Mine (find valid nonce)
<b class="fc">&nbsp;            String proofOfWork = calculateProofOfWork(block, difficulty);</b>
<b class="fc">&nbsp;            block.setHash(proofOfWork);</b>
&nbsp;
&nbsp;            // Save block
<b class="fc">&nbsp;            Block minedBlock = blockService.addBlock(block);</b>
&nbsp;
<b class="fc">&nbsp;            long miningDuration = System.currentTimeMillis() - startTime;</b>
<b class="fc">&nbsp;            BigDecimal reward = calculateMiningReward(nextIndex);</b>
&nbsp;
<b class="fc">&nbsp;            log.info(&quot;Block mined successfully in {} ms&quot;, miningDuration);</b>
<b class="fc">&nbsp;            return miningMapper.toResultDTO(minedBlock, miningDuration, reward);</b>
&nbsp;
&nbsp;        } catch (Exception e) {
<b class="nc">&nbsp;            log.error(&quot;Mining failed&quot;, e);</b>
<b class="nc">&nbsp;            long duration = System.currentTimeMillis() - startTime;</b>
<b class="nc">&nbsp;            return miningMapper.toFailedResultDTO(&quot;Mining failed: &quot; + e.getMessage());</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String calculateProofOfWork(Block block, Integer difficulty) {
<b class="fc">&nbsp;        String target = getDifficultyTarget(difficulty);</b>
&nbsp;        String hash;
<b class="fc">&nbsp;        int nonce = 0;</b>
&nbsp;
<b class="fc">&nbsp;        log.debug(&quot;Mining with target: {}&quot;, target);</b>
&nbsp;
&nbsp;        do {
<b class="fc">&nbsp;            nonce++;</b>
<b class="fc">&nbsp;            block.setNonce(nonce);</b>
<b class="fc">&nbsp;            hash = blockService.calculateBlockHash(block);</b>
&nbsp;
<b class="pc">&nbsp;            if (nonce % 100000 == 0) {</b>
<b class="nc">&nbsp;                log.debug(&quot;Tried {} nonces...&quot;, nonce);</b>
&nbsp;            }
<b class="fc">&nbsp;        } while (!hash.substring(0, difficulty).equals(target));</b>
&nbsp;
<b class="fc">&nbsp;        log.info(&quot;Proof of work found! Nonce: {}, Hash: {}&quot;, nonce, hash);</b>
<b class="fc">&nbsp;        return hash;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean verifyProofOfWork(Block block, Integer difficulty) {
<b class="fc">&nbsp;        String hash = blockService.calculateBlockHash(block);</b>
<b class="fc">&nbsp;        return hashMeetsDifficulty(hash, difficulty);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Integer getCurrentDifficulty() {
<b class="fc">&nbsp;        return DEFAULT_DIFFICULTY;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Integer adjustDifficulty(Long averageMiningTime) {
<b class="fc">&nbsp;        final long TARGET_TIME = 600000; // 10 minutes in milliseconds</b>
&nbsp;
<b class="fc">&nbsp;        if (averageMiningTime &lt;= TARGET_TIME / 2) {</b>
<b class="fc">&nbsp;            return DEFAULT_DIFFICULTY + 1;</b>
<b class="fc">&nbsp;        } else if (averageMiningTime &gt;= TARGET_TIME * 2) {</b>
<b class="fc">&nbsp;            return Math.max(1, DEFAULT_DIFFICULTY - 1);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return DEFAULT_DIFFICULTY;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public BigDecimal calculateMiningReward(Integer blockIndex) {
<b class="fc">&nbsp;        int halvings = blockIndex / HALVING_INTERVAL;</b>
<b class="fc">&nbsp;        BigDecimal reward = INITIAL_REWARD;</b>
&nbsp;
<b class="fc">&nbsp;        for (int i = 0; i &lt; halvings; i++) {</b>
<b class="fc">&nbsp;            reward = reward.divide(new BigDecimal(&quot;2&quot;));</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return reward;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Long getEstimatedMiningTime(Integer difficulty) {
&nbsp;        // Rough estimate based on difficulty; ensure it&#39;s at least 1 ms to avoid zero for small difficulties
<b class="fc">&nbsp;        long estimate = (long) (Math.pow(16.0, difficulty) / 1_000_000.0);</b>
<b class="fc">&nbsp;        return Math.max(1L, estimate);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean hashMeetsDifficulty(String hash, Integer difficulty) {
<b class="fc">&nbsp;        String target = getDifficultyTarget(difficulty);</b>
<b class="fc">&nbsp;        return hash.substring(0, difficulty).equals(target);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getDifficultyTarget(Integer difficulty) {
<b class="fc">&nbsp;        return &quot;0&quot;.repeat(difficulty);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2025-12-25 22:18</div>
</div>
</body>
</html>
